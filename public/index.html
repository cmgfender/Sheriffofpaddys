<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enhanced Media Release Calendar</title>

  <!-- FullCalendar Core + Plugins -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <!-- You need this for the list view plugin: -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
  <!-- (Optional) If you’re using separate plugin files, you’d add them like:
      <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/daygrid/main.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/list/main.min.js"></script>
  -->

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    /* Base styles */
    body {
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      color: #333;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    }

    /* Page container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      text-align: center;
    }

    h1 {
      margin-top: 20px;
      font-size: 1.8rem;
    }

    /* Calendar container */
    #calendar {
      max-width: 100%;
      margin: 20px auto;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    }

    /* Error message */
    .error-message {
      color: red;
      font-weight: bold;
      margin-top: 20px;
    }

    /* Tooltip styles */
    .fc-event {
      position: relative;
      cursor: pointer;
    }
    .fc-tooltip {
      position: absolute;
      background: #212121;
      color: #fff;
      padding: 5px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      pointer-events: none;
      z-index: 9999;
      transform: translate(-50%, -100%);
      white-space: nowrap;
      display: none;
    }
    .fc-event:hover .fc-tooltip {
      display: block;
    }

    /* Responsive tweaks */
    @media (max-width: 600px) {
      .container {
        padding: 0 10px;
      }
      #calendar {
        padding: 10px;
      }
      .fc .fc-toolbar-title {
        font-size: 1.2rem;
      }
      .fc .fc-daygrid-event {
        font-size: 0.85rem;
      }
      /* Adjust FullCalendar’s toolbar for smaller screens */
      .fc-header-toolbar {
        flex-wrap: wrap;
      }
      .fc-header-toolbar .fc-toolbar-chunk {
        margin-bottom: 10px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Upcoming Media Releases</h1>
    <p class="error-message" id="errorMessage" style="display: none;"></p>

    <div id="calendar"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const calendarEl = document.getElementById("calendar");
      const errorMessage = document.getElementById("errorMessage");

      // Initialize FullCalendar
      const calendar = new FullCalendar.Calendar(calendarEl, {
        // Include the plugins you’re actually using; 
        // The main script might already contain them, 
        // but for clarity you can specify them:
        // plugins: [ 'dayGrid', 'list' ],
        initialView: "dayGridMonth",
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          // Provide the dayGrid and list view options
          right: "dayGridMonth,listWeek"
        },
        dayMaxEventRows: 3,
        moreLinkContent: (args) => `+ ${args.num} more`,
        
        // RESPONSIVE CHANGE: switch to list view under 600px
        windowResize: function(view) {
          if (window.innerWidth < 600 && view.type !== "listWeek") {
            calendar.changeView("listWeek");
          } else if (window.innerWidth >= 600 && view.type !== "dayGridMonth") {
            calendar.changeView("dayGridMonth");
          }
        },

        // Simple tooltip on hover
        eventDidMount: function(info) {
          const tooltipEl = document.createElement("div");
          tooltipEl.classList.add("fc-tooltip");
          tooltipEl.innerHTML = info.event.title;
          info.el.appendChild(tooltipEl);
        },
        
        events: [] // We'll add events dynamically
      });

      calendar.render();

      // Use Vercel API as a proxy
      const BASE_URL = "https://www.sheriffofpaddys.com/api/proxy"; // Ensure this is correct
      const SONARR_PROXY_URL = `${BASE_URL}?service=sonarr`;
      const RADARR_PROXY_URL = `${BASE_URL}?service=radarr`;

      async function fetchReleases() {
        try {
          const [sonarrResponse, radarrResponse] = await Promise.all([
            fetch(SONARR_PROXY_URL).then(res => {
              if (!res.ok) throw new Error(`Sonarr API Error: ${res.status}`);
              return res.json();
            }),
            fetch(RADARR_PROXY_URL).then(res => {
              if (!res.ok) throw new Error(`Radarr API Error: ${res.status}`);
              return res.json();
            })
          ]);

          console.log("Sonarr Data:", sonarrResponse);
          console.log("Radarr Data:", radarrResponse);

          if (!Array.isArray(sonarrResponse) || !Array.isArray(radarrResponse)) {
            throw new Error("API response is not an array");
          }

          // Sonarr Events: [Series Title] - S[seasonNumber]E[episodeNumber]
          const sonarrEvents = sonarrResponse.map(show => {
            const seriesTitle = show.seriesTitle 
              || (show.series && show.series.title) 
              || show.title 
              || "Unknown Title";
            return {
              title: `${seriesTitle} - S${show.seasonNumber}E${show.episodeNumber}`,
              start: show.airDateUtc,
              color: "#2196F3"
            };
          });

          // Radarr Events: movie title on digital release date
          const radarrEvents = radarrResponse.map(movie => ({
            title: movie.title,
            start: movie.digitalRelease,
            color: "#E91E63"
          }));

          // Add both sets to the calendar
          calendar.addEventSource([...sonarrEvents, ...radarrEvents]);

          // Trigger a resize check so the calendar picks the right view
          calendar.updateSize();
        } catch (error) {
          console.error("Error fetching data:", error);
          errorMessage.style.display = "block";
          errorMessage.textContent = "Failed to load calendar data. Check console for details.";
        }
      }

      fetchReleases();
    });
  </script>
</body>
</html>